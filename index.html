<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mafia Online</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Corki+One&display=swap">
  <style>
    @font-face {
      font-family: 'Hippopotamus Apocalypse';
      src: url('Hippopotamus Apocalypse.otf') format('opentype');
    }

    body {
      margin: 0;
      padding: 0;
      background: url('https://raw.githubusercontent.com/MrLogin4ik/mafia-assets/main/assets/background.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Corki One', sans-serif;
      color: white;
    }

    .header {
      text-align: center;
      font-family: 'Hippopotamus Apocalypse', sans-serif;
      font-size: 48px;
      background: linear-gradient(to bottom, white, #aaa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-top: 20px;
    }

    .fullscreen-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      font-size: 30px;
      color: white;
      user-select: none;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 10px;
      padding: 20px;
      max-width: 1600px;
      margin: auto;
    }

    .player {
      position: relative;
      aspect-ratio: 4/3;
      background-color: black;
      overflow: hidden;
      border: 4px solid transparent;
      border-radius: 8px;
    }

    .player.voted {
      border-color: yellow;
    }

    .player img,
    .player iframe {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border: none;
    }

    .overlay {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.6);
      text-align: center;
      font-size: 18px;
      line-height: 1.2;
    }

    .overlay .number {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="fullscreen-toggle" onclick="toggleFullscreen()">⛶</div>
  <div class="header">MAFIA ONLINE</div>
  <div class="grid" id="grid"></div>

  <script>
    const SHEET_ID = '1_nKZQWCYFjZemK4HAqgCBL0JXjGmE7kHh7NvcKX61SM';
    const API_URL = `https://opensheet.elk.sh/${SHEET_ID}/Мафия Онлайн`;

    let lastCameras = Array(12).fill(null);

    async function fetchData() {
      try {
        const res = await fetch(API_URL);
        const rows = await res.json();
        updateGrid(rows);
      } catch (err) {
        console.error('Ошибка загрузки данных:', err);
      }
    }

    function updateGrid(rows) {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';

      for (let i = 0; i < 12; i++) {
        const row = rows[i] || {};
        const name = row['Участники'] || '';
        const number = row['Нумерация'] || '';
        const status = (row['Убитые'] || '').toLowerCase();
        const vote = row['На голосование'] || '';
        const cam = row['Ссылка на камеру VDO'] || '';

        const container = document.createElement('div');
        container.className = 'player';
        if (vote.trim() === '-') container.classList.add('voted');

        // Камера обновляется только если изменилась
        if (status === 'выгнан') {
          container.innerHTML = `<img src="https://raw.githubusercontent.com/MrLogin4ik/mafia-assets/main/assets/voted-out.jpg" />`;
          lastCameras[i] = null;
        } else if (status === 'убит') {
          container.innerHTML = `<img src="https://raw.githubusercontent.com/MrLogin4ik/mafia-assets/main/assets/killed.jpg" />`;
          lastCameras[i] = null;
        } else if (cam && lastCameras[i] !== cam) {
          lastCameras[i] = cam;
          container.innerHTML = `<iframe src="${cam}" allow="camera; microphone" allowfullscreen></iframe>`;
        } else if (!cam) {
          lastCameras[i] = null;
          container.innerHTML = `<img src="https://raw.githubusercontent.com/MrLogin4ik/mafia-assets/main/assets/empty.jpg" />`;
        } else {
          // Камера не изменилась, не обновляем iframe, оставляем пустым
          container.innerHTML = '';
        }

        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        overlay.innerHTML = `<div class="number">${number}</div><div>${name}</div>`;
        container.appendChild(overlay);

        grid.appendChild(container);
      }
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    fetchData();
    setInterval(fetchData, 1500);
  </script>
</body>
</html>
