<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mafia Online</title>
  <link href="https://fonts.googleapis.com/css2?family=Hippopotamus+Apocalypse&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: 'Hippopotamus Apocalypse', sans-serif;
      background: url("https://raw.githubusercontent.com/MrLogin4ik/mafia-assets/refs/heads/main/assets/background.jpg") no-repeat center center fixed;
      background-size: cover;
    }
    h1 {
      color: fuchsia;
      text-align: center;
      font-size: 2.5em;
      margin-top: 10px;
      text-shadow: 2px 2px 3px black;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 5px;
      padding: 10px;
      width: 100vw;
      height: calc(100vh - 130px);
      box-sizing: border-box;
    }
    .slot {
      position: relative;
      border: 2px solid white;
      border-radius: 10px;
      overflow: hidden;
      background-color: black;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .slot.raised {
      border: 4px solid yellow;
    }
    .slot iframe, .slot img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: black;
      display: block;
    }
    .label {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      text-align: center;
      font-weight: bold;
      padding: 4px 0;
      z-index: 2;
      font-size: 0.9em;
    }
    .fullscreen-button {
      position: fixed;
      bottom: 10px;
      right: 10px;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: 2px solid white;
      border-radius: 8px;
      cursor: pointer;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <h1>MAFIA ONLINE</h1>
  <div class="grid" id="grid"></div>
  <div class="fullscreen-button" onclick="toggleFullscreen()">⛶ Fullscreen</div>

  <script>
    const sheetURL = 'https://docs.google.com/spreadsheets/d/1_nKZQWCYFjZemK4HAqgCBL0JXjGmE7kHh7NvcKX61SM/gviz/tq?tqx=out:json';

    async function fetchData() {
      try {
        const res = await fetch(sheetURL);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows;

        const players = [];

        for (let i = 0; i < 12; i++) {
          const row = rows[i];
          if (!row) continue;
          players.push({
            name: row?.c[0]?.v || '',
            role: row?.c[1]?.v || '',
            status: row?.c[2]?.v?.toLowerCase() || '',
            voted: row?.c[3]?.v === '*' || row?.c[3]?.v?.toLowerCase() === 'да',
            cam: row?.c[4]?.v || '',
            number: row?.c[5]?.v || ''
          });
        }

        if (rows[12]) {
          const host = {
            name: rows[12]?.c[0]?.v || '',
            role: rows[12]?.c[1]?.v || '',
            status: rows[12]?.c[2]?.v?.toLowerCase() || '',
            voted: rows[12]?.c[3]?.v === '*' || rows[12]?.c[3]?.v?.toLowerCase() === 'да',
            cam: rows[12]?.c[4]?.v || '',
            number: rows[12]?.c[5]?.v || ''
          };
          const index = players.findIndex(p => p.name === host.name);
          if (index !== -1) players.splice(index, 1);
          players.push(host);
        }

        renderGrid(players);
      } catch (e) {
        console.error('Ошибка загрузки таблицы:', e);
      }
    }

    function renderGrid(players) {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';

      players.forEach((p) => {
        const div = document.createElement('div');
        div.className = 'slot';
        if (p.voted) div.classList.add('raised');

        if (p.status === 'убит') {
          div.innerHTML = `<img src="https://raw.githubusercontent.com/MrLogin4ik/mafia-assets/refs/heads/main/assets/killed.jpg" alt="killed" />`;
        } else if (p.status === 'выгнан') {
          div.innerHTML = `<img src="https://raw.githubusercontent.com/MrLogin4ik/mafia-assets/refs/heads/main/assets/voted-out.jpg" alt="voted out" />`;
        } else if (p.cam) {
          div.innerHTML = `<iframe src="${p.cam}" allow="camera; microphone" frameborder="0"></iframe>`;
        } else {
          div.innerHTML = `<img src="https://raw.githubusercontent.com/MrLogin4ik/mafia-assets/refs/heads/main/assets/empty.jpg" alt="empty" />`;
        }

        if (p.name) {
          const label = document.createElement('div');
          label.className = 'label';
          label.textContent = `${p.number}) ${p.name}`;
          div.appendChild(label);
        }

        grid.appendChild(div);
      });
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    fetchData();
  </script>
</body>
</html>
