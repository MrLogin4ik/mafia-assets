<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mafia Online</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Corki+One&display=swap">
  <style>
    @font-face {
      font-family: 'Hippopotamus Apocalypse';
      src: url('Hippopotamus Apocalypse.otf') format('opentype');
    }

    body {
      margin: 0;
      padding: 0;
      background: url('https://raw.githubusercontent.com/MrLogin4ik/mafia-assets/main/assets/background.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Corki One', sans-serif;
      color: white;
    }

    .header {
      text-align: center;
      font-family: 'Hippopotamus Apocalypse', sans-serif;
      font-size: 48px;
      background: linear-gradient(to bottom, white, #aaa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-top: 20px;
    }

    .fullscreen-toggle, .menu-toggle {
      position: absolute;
      top: 10px;
      cursor: pointer;
      font-size: 20px;
      background: rgba(0,0,0,0.4);
      padding: 5px 10px;
      border-radius: 4px;
      user-select: none;
      z-index: 1001;
    }

    .fullscreen-toggle {
      right: 10px;
    }

    .menu-toggle {
      right: 60px;
      display: none;
    }

    .menu {
      display: none;
      position: absolute;
      top: 40px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 6px;
      z-index: 1000;
    }

    .menu select, .menu button {
      margin: 5px 0;
      width: 100%;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1vw;
      padding: 1vw;
      max-width: 100%;
      width: 100%;
      box-sizing: border-box;
    }

    .player {
      position: relative;
      aspect-ratio: 16/9;
      background-color: black;
      overflow: hidden;
      border: 4px solid transparent;
      border-radius: 8px;
    }

    .player.voted {
      border-color: yellow;
    }

    .player img,
    .player iframe {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border: none;
    }

    .overlay {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.6);
      text-align: center;
      font-size: 18px;
      line-height: 1.2;
      pointer-events: none;
    }

    .overlay .number {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="menu-toggle" id="menuToggle">Меню</div>
  <div class="fullscreen-toggle" onclick="toggleFullscreen()">⛶</div>
  <div class="menu" id="menu">
    <select id="playerSelect">
      <option disabled selected>Выберите игрока</option>
      <script>
        for (let i = 0; i < 12; i++) {
          document.write(`<option value="${i + 2}">Игрок ${i + 1}</option>`);
        }
      </script>
    </select>
    <button onclick="updateStatus('убит')">Убить игрока</button>
    <button onclick="updateStatus('выгнан')">Выгнать игрока</button>
    <button onclick="updateVote('-')">Выставить на голосование</button>
  </div>
  <div class="header">MAFIA ONLINE</div>
  <div class="grid" id="grid"></div>

  <script>
    const CREATOR_EMAIL = "bnemno@gmail.com";
    const API_KEY = 'AIzaSyDvwTNSPQPn1nlHvn4GVllcWZm_dq6QCXQ';
    const SHEET_ID = '1_nKZQWCYFjZemK4HAqgCBL0JXjGmE7kHh7NvcKX61SM';
    const RANGE = 'Мафия Онлайн!B2:F14';

    let lastCameras = Array(12).fill(null);

    async function fetchData() {
      try {
        const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`);
        const data = await res.json();
        const rows = data.values || [];
        updateGrid(rows);
      } catch (err) {
        console.error('Ошибка загрузки данных:', err);
      }
    }

    function updateGrid(rows) {
      const grid = document.getElementById('grid');
      for (let i = 0; i < 12; i++) {
        const row = rows[i] || [];
        const name = row[0] || '';
        const number = row[1] || '';
        const status = (row[2] || '').toLowerCase();
        const vote = row[3] || '';
        const cam = row[4] || '';

        let container = document.getElementById(`player-${i}`);
        if (!container) {
          container = document.createElement('div');
          container.className = 'player';
          container.id = `player-${i}`;
          grid.appendChild(container);
        }

        container.classList.toggle('voted', vote.trim() === '-');

        const currentStatus = container.getAttribute('data-status');
        const currentCam = container.getAttribute('data-cam');

        if (status !== currentStatus || cam !== currentCam) {
          container.setAttribute('data-status', status);
          container.setAttribute('data-cam', cam);

          if (status === 'выгнан') {
            container.innerHTML = `<img src="https://raw.githubusercontent.com/MrLogin4ik/mafia-assets/main/assets/voted-out.jpg">`;
          } else if (status === 'убит') {
            container.innerHTML = `<img src="https://raw.githubusercontent.com/MrLogin4ik/mafia-assets/main/assets/killed.jpg">`;
          } else if (cam) {
            container.innerHTML = `<iframe src="${cam}" allow="autoplay; camera; microphone; fullscreen" allowfullscreen></iframe>`;
          } else {
            container.innerHTML = `<img src="https://raw.githubusercontent.com/MrLogin4ik/mafia-assets/main/assets/empty.jpg">`;
          }
        }

        const oldOverlay = container.querySelector('.overlay');
        if (oldOverlay) oldOverlay.remove();

        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        overlay.innerHTML = `<div class="number">${number}</div><div>${name}</div>`;
        container.appendChild(overlay);
      }
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    function updateStatus(status) {
      const row = document.getElementById('playerSelect').value;
      const col = 'D';
      updateCell(col + row, status);
    }

    function updateVote(value) {
      const row = document.getElementById('playerSelect').value;
      const col = 'E';
      updateCell(col + row, value);
    }

    async function updateCell(cell, value) {
      const body = { values: [[value]] };
      await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${cell}?valueInputOption=RAW&key=${API_KEY}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      const userEmail = prompt("Введите вашу почту для доступа к панели управления:");
      if (userEmail === CREATOR_EMAIL) {
        document.getElementById('menuToggle').style.display = 'block';
      }
    });

    document.getElementById('menuToggle').addEventListener('click', (e) => {
      e.stopPropagation();
      const menu = document.getElementById('menu');
      menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    });

    document.addEventListener('click', (e) => {
      const menu = document.getElementById('menu');
      if (!menu.contains(e.target) && e.target.id !== 'menuToggle') {
        menu.style.display = 'none';
      }
    });

    fetchData();
    setInterval(fetchData, 2000);
  </script>
</body>
</html>
