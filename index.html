<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mafia Online</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Corki+One&display=swap">
  <style>
    @font-face {
      font-family: 'Hippopotamus Apocalypse';
      src: url('Hippopotamus Apocalypse.otf') format('opentype');
    }

    body {
      margin: 0;
      padding: 0;
      background: url('https://raw.githubusercontent.com/MrLogin4ik/mafia-assets/main/assets/background.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Corki One', sans-serif;
      color: white;
    }

    .header {
      text-align: center;
      font-family: 'Hippopotamus Apocalypse', sans-serif;
      font-size: 48px;
      background: linear-gradient(to bottom, white, #aaa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-top: 20px;
    }

    .fullscreen-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      font-size: 30px;
      color: white;
      user-select: none;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1vw;
      padding: 1vw;
      max-width: 100%;
      width: 100%;
      box-sizing: border-box;
    }

    .player {
      position: relative;
      aspect-ratio: 16/9;
      background-color: black;
      overflow: hidden;
      border: 4px solid transparent;
      border-radius: 8px;
    }

    .player.voted {
      border-color: yellow;
    }

    .player img,
    .player iframe {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border: none;
    }

    .overlay {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.6);
      text-align: center;
      font-size: 18px;
      line-height: 1.2;
      pointer-events: none;
    }

    .overlay .number {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="fullscreen-toggle" onclick="toggleFullscreen()">‚õ∂</div>
  <div class="header">MAFIA ONLINE</div>
  <div class="grid" id="grid"></div>

  <script>
    const API_KEY = 'AIzaSyDvwTNSPQPn1nlHvn4GVllcWZm_dq6QCXQ';
    const SHEET_ID = '1_nKZQWCYFjZemK4HAqgCBL0JXjGmE7kHh7NvcKX61SM';
    const RANGE = '–ú–∞—Ñ–∏—è –û–Ω–ª–∞–π–Ω!B2:F14';
    let lastCameras = Array(12).fill(null);
    let initialized = false;

    async function fetchData() {
      try {
        const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`);
        const data = await res.json();
        const rows = data.values || [];
        updateGrid(rows);
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', err);
      }
    }

    function updateGrid(rows) {
      const grid = document.getElementById('grid');

      for (let i = 0; i < 12; i++) {
        const row = rows[i] || [];
        const name = row[0] || '';
        const number = row[1] || '';
        const status = (row[2] || '').toLowerCase();
        const vote = row[3] || '';
        const cam = row[4] || '';

        let container = document.getElementById(`player-${i}`);

        if (!container) {
          container = document.createElement('div');
          container.className = 'player';
          container.id = `player-${i}`;
          grid.appendChild(container);
        }

        container.classList.toggle('voted', vote.trim() === '-');

        // –ö–∞–º–µ—Ä–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
        const currentStatus = container.getAttribute('data-status');
        const currentCam = container.getAttribute('data-cam');

        if (status !== currentStatus || cam !== currentCam) {
          container.setAttribute('data-status', status);
          container.setAttribute('data-cam', cam);

          if (status === '–≤—ã–≥–Ω–∞–Ω') {
            container.innerHTML = `<img src="https://raw.githubusercontent.com/MrLogin4ik/mafia-assets/main/assets/voted-out.jpg">`;
          } else if (status === '—É–±–∏—Ç') {
            container.innerHTML = `<img src="https://raw.githubusercontent.com/MrLogin4ik/mafia-assets/main/assets/killed.jpg">`;
          } else if (cam) {
            container.innerHTML = `<iframe src="${cam}" allow="autoplay; camera; microphone; fullscreen" allowfullscreen></iframe>`;
          } else {
            container.innerHTML = `<img src="https://raw.githubusercontent.com/MrLogin4ik/mafia-assets/main/assets/empty.jpg">`;
          }
        }

        // overlay –≤—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º
        const oldOverlay = container.querySelector('.overlay');
        if (oldOverlay) oldOverlay.remove();

        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        overlay.innerHTML = `<div class="number">${number}</div><div>${name}</div>`;
        container.appendChild(overlay);
      }
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    fetchData();
    setInterval(fetchData, 2000);
  </script>
  <!-- –ö–ù–û–ü–ö–ê –ò –ú–ï–ù–Æ –î–õ–Ø –í–ï–î–£–©–ï–ì–û -->
<div id="menuButton" style="display: none; position: absolute; top: 10px; right: 60px; cursor: pointer; font-size: 20px; color: white; user-select: none; z-index: 9999;">
  üìã –ú–ï–ù–Æ
</div>

<div id="hostMenu" style="display: none; position: absolute; top: 50px; right: 20px; background: rgba(0,0,0,0.85); padding: 12px; border-radius: 8px; color: white; z-index: 9999;">
  <label>–ò–≥—Ä–æ–∫:
    <select id="playerSelect">
      <option value="0">–ò–≥—Ä–æ–∫ 1</option>
      <option value="1">–ò–≥—Ä–æ–∫ 2</option>
      <option value="2">–ò–≥—Ä–æ–∫ 3</option>
      <option value="3">–ò–≥—Ä–æ–∫ 4</option>
      <option value="4">–ò–≥—Ä–æ–∫ 5</option>
      <option value="5">–ò–≥—Ä–æ–∫ 6</option>
      <option value="6">–ò–≥—Ä–æ–∫ 7</option>
      <option value="7">–ò–≥—Ä–æ–∫ 8</option>
      <option value="8">–ò–≥—Ä–æ–∫ 9</option>
      <option value="9">–ò–≥—Ä–æ–∫ 10</option>
      <option value="10">–ò–≥—Ä–æ–∫ 11</option>
    </select>
  </label><br><br>
  <label>–î–µ–π—Å—Ç–≤–∏–µ:
    <select id="actionSelect">
      <option value="-">–í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</option>
      <option value="—É–±–∏—Ç">–£–±–∏—Ç—å –∏–≥—Ä–æ–∫–∞</option>
      <option value="–≤—ã–≥–Ω–∞–Ω">–í—ã–≥–Ω–∞—Ç—å –∏–≥—Ä–æ–∫–∞</option>
    </select>
  </label><br><br>
  <button onclick="applyAction()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
</div>

<script>
  const CLIENT_ID = '497618593889-eqqgihnda1t47eo4jbh5h0u33p20o98s.apps.googleusercontent.com';
  const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
  let tokenClient, gapiInited = false, gisInited = false;

  function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
  }

  async function initializeGapiClient() {
    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
    });
    await gapi.client.load('oauth2', 'v2');
    gapiInited = true;
  }

  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: '',
    });
    gisInited = true;
  }

  function applyAction() {
    let pendingCallback = null;

function applyAction() {
  const playerIndex = parseInt(document.getElementById('playerSelect').value);
  const action = document.getElementById('actionSelect').value;

  pendingCallback = async () => {
    const userInfo = await gapi.client.oauth2.userinfo.get();
    const userEmail = userInfo.result.email;

    if (userEmail !== 'bnemno@gmail.com') return;

    document.getElementById('menuButton').style.display = 'block';

    const range = action === '-' ? `–ú–∞—Ñ–∏—è –û–Ω–ª–∞–π–Ω!E${playerIndex + 2}` : `–ú–∞—Ñ–∏—è –û–Ω–ª–∞–π–Ω!D${playerIndex + 2}`;
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range
    });
    const current = res.result.values ? res.result.values[0][0] : '';
    const newValue = current === action ? '' : action;

    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: SHEET_ID,
      range,
      valueInputOption: 'USER_ENTERED',
      resource: { values: [[newValue]] }
    });

    alert('–û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + (newValue || '–æ—á–∏—â–µ–Ω–æ'));
  };

  ensureAccessToken(pendingCallback);
}
    function ensureAccessToken(callback) {
  const token = gapi.client.getToken();

  if (!token) {
    tokenClient.callback = (resp) => {
      if (resp && resp.error) {
        alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏");
        console.error(resp);
      } else {
        if (callback) callback();
      }
    };
    tokenClient.requestAccessToken({ prompt: 'none' });
  } else {
    callback();
  }
}

  // –ü–æ–∫–∞–∑ / —Å–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é
  document.getElementById('menuButton').onclick = () => {
    const menu = document.getElementById('hostMenu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  };

  document.body.addEventListener('click', (e) => {
    if (!e.target.closest('#hostMenu') && e.target.id !== 'menuButton') {
      document.getElementById('hostMenu').style.display = 'none';
    }
  });
</script>

<script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  
</body>
</html>
